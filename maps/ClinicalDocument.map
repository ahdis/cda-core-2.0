map "http://hl7.org/fhir/cda/mapping/ClinicalDocumentToFHIR" = "CDA Document to FHIR"

uses "http://hl7.org/fhir/cda/StructureDefinition/ClinicalDocument" alias ClinicalDocument as source
uses "http://hl7.org/fhir/cda/StructureDefinition/AssignedAuthor" alias AssignedAuthor as queried
uses "http://hl7.org/fhir/cda/StructureDefinition/AssignedEntity" alias AssignedEntity as queried
uses "http://hl7.org/fhir/cda/StructureDefinition/CustodianOrganization" alias CustodianOrganization as queried
uses "http://hl7.org/fhir/cda/StructureDefinition/Section" alias Section as queried
uses "http://hl7.org/fhir/cda/StructureDefinition/PatientRole" alias PatientRole as queried
uses "http://hl7.org/fhir/StructureDefinition/Bundle" alias Bundle as target
uses "http://hl7.org/fhir/StructureDefinition/Composition" alias Composition as produced
uses "http://hl7.org/fhir/StructureDefinition/Patient" alias Patient as produced
uses "http://hl7.org/fhir/StructureDefinition/Practitioner" alias Practitioner as produced
uses "http://hl7.org/fhir/StructureDefinition/Organization" alias Organization as produced

imports "http://hl7.org/fhir/cda/mapping/cdaToFhirTypes"
imports "http://hl7.org/fhir/cda/mapping/ClinicalDocumentHeaderToFHIR"

group ClinicalDocumentBundle(source cda : ClinicalDocument, target bundle : Bundle) extends ClinicalDocumentBundleHeader {
  cda ->  bundle.entry as e first,  e.resource = create('Composition') as composition, 
             bundle.entry as e2, e2.resource = create('Patient') as patient 
             then {
                cda then ClinicalDocumentComposition(cda, composition, patient, bundle) "composition";
                cda.component as component then {
                  component.structuredBody as body then {
                    body.component as component then CDASections(cda, component, patient, composition, bundle) "bodyComponent";
                  } "body";
                } "component";
             } "then";
}

group CDASections(source cda : ClinicalDocument, source component, source patient : Patient, target composition : Composition, target bundle : Bundle) {
  component.section as srcSection -> composition.section as tgtSection then ClinicalDocumentSection(srcSection, patient, tgtSection, bundle);
}